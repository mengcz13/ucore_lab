# LAB2 实验报告
计45 孟垂正 2013010952

## 练习1: 实现 first-fit 连续物理内存分配算法

具体实现详见`default_pmm.c`中的`default_init_memmap`, `default_alloc_pages`, `default_free_pages`函数.

实现思路为将每个空闲连续内存块的首个页表加入free\_list中进行管理. 过程概述如下:
- `default_init_memmap`: 初始化可分配的内存, 使用连续的n个页表作为初始的待分配内存. 将`base`作为这块内存的第一页加入free\_list, 设置flag, property和ref.
- `default_alloc_pages`: 使用first-fit找到合适的第一块内存, 将其第一页从free\_list中移除. 如果该块仍有剩余空间则将剩余空间的第一页加入free\_list.
- `default_free_pages`: 遍历链表找到待插入内存块按地址顺序在链表中的位置并插入. 分别向后/向前尝试合并可能存在的可合并块.

可改进之处: `Page`结构的`PG_property`位表明了自身是否在free\_list中, 如果在后续实验中不被用到可考虑忽略对它的处理.

## 练习2: 实现寻找虚拟地址对应的页表项

具体实现详见`pmm.c`中的`get_pte`. 获取二级页表项逻辑地址的过程概述如下:

一级页表基逻辑地址+la中得到的一级页表偏移->一级页表项逻辑地址->一级页表项->二级页表基物理地址->二级页表基逻辑地址+la中得到的二级页表偏移->二级页表项逻辑地址.

得到一级页表项后可能不存在对应的二级页表, 需要手动分配新页并与该一级页表项关联, 即填入新页的物理地址.

### 请描述页目录项(Pag Director Entry)和页表(Page Table Entry)中每个组成部分的含义和以及对ucore而言的潜在用处.

`页目录项内容 = (二级页表起始物理地址 &0x0FFF) | PTE_U | PTE_W | PTE_P`
- 二级页表起始物理地址: 字面意思. ucore通过修改此地址可以建立一级页表与二级页表之间的映射关系.
- PTE\_U: 用户态是否有访问权限. 用于权限控制.
- PTE\_W: 是否可写. ucore可以用此来保持确定的映射关系.
- PTE\_P: 对应的二级页表是否存在. 不存在时ucore会为之分配新页.

`页表项内容 = (页起始物理地址 & ~0x0FFF) | PTE_P | PTE_W`
- 页起始物理地址: 字面意思. ucore通过修改此地址建立二级页表与物理帧之间的映射关系.
- PTE\_U: 用户态是否有访问权限. 用于权限控制.
- PTE\_W: 是否可写. ucore可以用此来保持确定的映射关系.
- PTE\_P: 对应的物理帧是否存在. 不存在时发生缺页异常, ucore会从外存载入对应页.

### 如果ucore执行过程中访问内存, 出现了页访问异常, 请问硬件要做哪些事情?

- 转到中断处理程序入口
- 根据中断处理程序要求进行读写外存或者其他操作
- 若可能则恢复执行

## 练习3: 释放某虚地址所在的页并取消对应二级页表项的映射

具体实现详见`pmm.c`中的`page_remove_pte`. 实现思路概述如下:

- 释放指定的页.
- 清零对应页表项的地址.
- tlb标记失效.

### 数据结构Page的全局变量(其实是一个数组)的每一项与页表中的页目录项和页表项有无对应关系? 如果有, 其对应关系是啥?

存在对应关系. Page中每一项的序号为该页物理地址的PPN, 包含该页在页目录表和页表中的偏移量.

### 如果希望虚拟地址与物理地址相等, 则需要如何修改lab2, 完成此事?

将`memlayout.h`中的`KERNBASE`修改为0, 同时链接脚本中ucore的起始地址应修改为0x100000.

## 与参考答案的区别

练习1与参考答案区别较大, 练习2和练习3与参考答案基本一致.

练习1中我的做法已在上文叙述, 而参考答案的做法是将所有空闲页都插入到了free\_list中, 我认为没有这个必要. 而且参考答案在分配时将所有分配出去的页均置位reserved, 这种做法很奇怪, 因为标记为reserved的页后面不应该继续参与内存分配, 而实际上这些分配出去的页后面还会被回收并重新分配.

## 实验中重要的知识点

- 连续物理内存分配算法, 对应练习1.
- 页目录表和页表的访问方法, 对应练习2和练习3.

## 没有对应的知识点

- 特权级的判断和切换, 本次实验中相关内容不多, 实验1中的challenge部分涉及更多一些.